import tensorflow as tf
import numpy as np
import pandas as pd

# 1. NHẬP DỮ LIỆU CỦA BẠN VÀO ĐÂY (Thay thế đống số này bằng dữ liệu bạn copy từ Serial)
# Định dạng: [Nhiệt độ, Độ ẩm]
raw_data = [
   # Dán dữ liệu vào đây
  [29.00, 68.00],
[29.00, 68.00],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.70],
[29.00, 67.70],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 68.00],
[29.00, 68.00],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 68.00],
[29.00, 68.00],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.90],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.70],
[29.00, 67.70],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.70],
[29.00, 67.70],
[29.00, 67.80],
[29.00, 67.80],
[29.10, 67.70],
[29.10, 67.70],
[29.00, 67.60],
[29.00, 67.60],
[29.00, 67.60],
[29.00, 67.60],
[29.10, 67.60],
[29.10, 67.60],
[29.00, 67.60],
[29.00, 67.60],
[29.00, 67.70],
[29.00, 67.70],
[29.00, 67.60],
[29.00, 67.60],
[29.00, 67.60],
[29.00, 67.60],
[29.00, 67.70],
[29.00, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.00, 67.70],
[29.00, 67.70],
[29.00, 67.80],
[29.00, 67.80],
[29.10, 67.80],
[29.10, 67.80],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.80],
[29.10, 67.80],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.00, 67.70],
[29.00, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.80],
[29.10, 67.80],
[29.00, 67.80],
[29.00, 67.80],
[29.00, 67.70],
[29.00, 67.70],
[29.10, 67.80],
[29.10, 67.80],
[29.00, 67.70],
[29.00, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.80],
[29.10, 67.80],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.80],
[29.10, 67.80],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.80],
[29.10, 67.80],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.80],
[29.10, 67.80],
[29.10, 67.90],
[29.10, 67.90],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
[29.10, 67.70],
]

# 2. CHUẨN HÓA DỮ LIỆU (Chia cho 100 để về khoảng 0-1)
data = np.array(raw_data) / 100.0

# 3. TẠO MODEL (Autoencoder đơn giản)
model = tf.keras.Sequential([
    tf.keras.layers.Dense(8, activation='relu', input_shape=(2,)), # Lớp vào
    tf.keras.layers.Dense(2, activation='relu'),                   # Lớp nén (Bottleneck)
    tf.keras.layers.Dense(8, activation='relu'),                   # Lớp giải nén
    tf.keras.layers.Dense(2, activation='sigmoid')                 # Lớp ra
])
model.compile(optimizer='adam', loss='mse')

# 4. TRAIN MODEL
print("Dang train...")
model.fit(data, data, epochs=500, batch_size=4, verbose=0)
print("Train xong!")

# 5. CHUYỂN ĐỔI SANG TENSORFLOW LITE
converter = tf.lite.TFLiteConverter.from_keras_model(model)
tflite_model = converter.convert()

# 6. XUẤT RA MÃ HEX (C Array)
def hex_to_c_array(hex_data, var_name):
    c_str = ''
    c_str += '#ifndef DHT_ANOMALY_MODEL_H\n'
    c_str += '#define DHT_ANOMALY_MODEL_H\n\n'
    c_str += 'const unsigned char ' + var_name + '[] = {\n'
    hex_array = []
    for i, val in enumerate(hex_data):
        hex_array.append(f'0x{val:02x}')
    c_str += ', '.join(hex_array)
    c_str += '};\n\n#endif'
    return c_str

with open("dht_anomaly_model.h", "w") as f:
    f.write(hex_to_c_array(tflite_model, 'dht_anomaly_model_tflite'))

print("\n>>> COPY ĐOẠN DƯỚI ĐÂY VÀO FILE dht_anomaly_model.h CỦA BẠN: <<<\n")
print(hex_to_c_array(tflite_model, 'dht_anomaly_model_tflite'))